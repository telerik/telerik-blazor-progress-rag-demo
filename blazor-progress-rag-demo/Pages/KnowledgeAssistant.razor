@page "/knowledge-assistant"
@using Progress.Nuclia
@using Progress.Nuclia.Model
@using Progress.Nuclia.Model.Streaming
@using Telerik.Blazor.Components
@using Telerik.SvgIcons
@using System.Collections.ObjectModel
@using blazor_progress_rag_demo.Services

<DrawerComponent>
    <div class="knowledge-assistant-container k-d-flex k-flex-column k-overflow-x-hidden k-pos-relative k-h-full">

        @* Background Illustration with Vectors - Only show in idle state *@
        <VectorsBackground Show="@(!HasConversationStarted)" />

        @* Hero Section - Only visible in idle state *@
        @if (!HasConversationStarted)
        {
            <div class="knowledge-assistant-hero k-d-flex k-flex-column knowledge-assistant-hero-wrapper k-pos-relative">
                <div class="knowledge-assistant-hero-content k-d-flex k-flex-column k-w-full k-gap-9">
                    <h1 class="knowledge-assistant-title !k-mb-0 k-h1">
                        Progress Agentic RAG Knowledge Assistant
                    </h1>
                    <p class="knowledge-assistant-description !k-mb-0">
                        Use AI search to quickly find accurate, relevant information about Progress Agentic RAGâ€”its features, capabilities, and best practices.
                    </p>
                </div>
            </div>
        }

        @if (HasConversationStarted)
        {
            <ChatHeader Messages="@ChatMessagesAsInterface" />
        }

        @* Chat Component *@
        <div class="knowledge-assistant-conversation k-d-flex k-flex-column k-flex-1 k-align-items-center k-w-full k-p-6 k-gap-8 conversation-container @(HasConversationStarted ? "knowledge-assistant-conversation-started" : "")">
            <div class="knowledge-assistant-chat-wrapper chat-content-wrapper k-w-full k-d-flex k-flex-column k-pos-relative @(!HasConversationStarted ? "show-gradient" : "") @(HasConversationStarted ? "knowledge-assistant-chat-flex-full" : "knowledge-assistant-chat-flex-none")">
                <TelerikChat @ref="ChatRef"
                             Data="@(HasConversationStarted? ChatMessages.Skip(1).ToList() : ChatMessages.ToList())"
                             OnSendMessage="@OnSendMessageHandler"
                             AuthorId="@CurrentUserId"
                             AuthorImageUrlField="AuthorImageUrl"
                             Class="k-border-transparent"
                             Height="@(HasConversationStarted ? "100%" : null)"
                             MessageWidthMode="MessageWidthMode.Full">
                    <MessageTemplate>
                        @{
                            var message = context.Message;
                            var isTyping = message is ChatMessageModel chatModel && chatModel.IsTyping;
                        }
                        <ChatMessage Text="@message?.Text"
                                     AuthorId="@message?.AuthorId"
                                     UserId="@CurrentUserId"
                                     IsTyping="@isTyping" />
                    </MessageTemplate>
                    <TimestampTemplate>
                        @* Empty to hide timestamps *@
                    </TimestampTemplate>
                    <MessageBoxTemplate>
                        <ChatMessageBox IsLoading="@IsLoading"
                                        Suggestions="@AvailableSuggestions"
                                        OnSuggestionClick="@HandleSuggestionClick"
                                        OnSendMessage="@HandleSendMessage"
                                        Placeholder="Try a suggestion or ask about KendoReact..." />
                    </MessageBoxTemplate>
                </TelerikChat>
            </div>
        </div>
    </div>
</DrawerComponent>

@code {
    private TelerikChat<ChatMessageModel>? ChatRef { get; set; }
    private bool IsLoading { get; set; } = false;
    private string CurrentUserId { get; set; } = "user";

    private ObservableCollection<ChatMessageModel> ChatMessages { get; set; } = new ObservableCollection<ChatMessageModel>();

    private bool HasConversationStarted => ChatMessages.Count > 1;

    private IEnumerable<IChatMessage> ChatMessagesAsInterface => ChatMessages.Cast<IChatMessage>();

    private List<ChatSuggestion> KendoSuggestions = new List<ChatSuggestion>
    {
        new ChatSuggestion("1", "How do I get started with KendoReact components?"),
        new ChatSuggestion("2", "What are the best KendoReact components for data visualization?"),
        new ChatSuggestion("3", "How to implement theming and styling in KendoReact?")
    };

    private List<ChatSuggestion> AvailableSuggestions => ChatMessages.Count <= 1 ? KendoSuggestions : new List<ChatSuggestion>();

    private readonly NucliaDbClient nucliaSearchClient;

    public KnowledgeAssistant([FromKeyedServices("default")] NucliaDbClient client)
    {
        nucliaSearchClient = client;
    }

    protected override void OnInitialized()
    {
        // Initial Welcome Message
        ChatMessages.Add(new ChatMessageModel
        {
            Text = "ðŸ‘‹ Hello! I'm your Progress Agentic RAG AI assistant. I can help you with KendoReact questions and documentation. Try one of the suggestions below, or ask me anything about KendoReact like:\n- components\n- theming\n- data visualization\n- and more!",
            AuthorId = "bot",
            AuthorName = "Assistant",
            Timestamp = DateTime.Now
        });
    }

    private async Task OnSendMessageHandler(ChatSendMessageEventArgs args)
    {
        await SendMessage(args.Message);
    }

    private async Task HandleSendMessage(string text)
    {
        await SendMessage(text);
    }

    private async Task HandleSuggestionClick(ChatSuggestion suggestion)
    {
        await SendMessage(suggestion.Text);
    }

    private async Task SendMessage(string messageText)
    {
        var userMessage = new ChatMessageModel
        {
            Text = messageText,
            AuthorId = CurrentUserId,
            AuthorName = "",
            AuthorImageUrl = "images/drawer-user.svg",
            Timestamp = DateTime.Now
        };

        ChatMessages.Add(userMessage);
        IsLoading = true;
        StateHasChanged();

        // Bot Response Placeholder with typing indicator
        var botMessage = new ChatMessageModel
        {
            Text = "",
            AuthorId = "bot",
            AuthorName = "",
            Timestamp = DateTime.Now.AddMilliseconds(1),
            IsTyping = true
        };
        ChatMessages.Add(botMessage);
        var index = ChatMessages.IndexOf(botMessage);

        StateHasChanged();

        try
        {
            var streamingText = "";
            await foreach (var response in nucliaSearchClient.Search.AskStreamAsync(new AskRequest(messageText) { TopK = 5 }))
            {
                if (response.Item is AnswerContent answer)
                {
                    streamingText += answer.Text;
                    var updatedMessage = new ChatMessageModel
                    {
                        Id = botMessage.Id,
                        Text = streamingText,
                        AuthorId = botMessage.AuthorId,
                        AuthorName = botMessage.AuthorName,
                        Timestamp = botMessage.Timestamp,
                        IsTyping = false
                    };
                    ChatMessages[index] = updatedMessage;
                    botMessage = updatedMessage;
                    await Task.Delay(1); // brief yield for UI responsiveness
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            ChatMessages[index] = new ChatMessageModel
            {
                Id = botMessage.Id,
                Text = "Sorry, I encountered an error processing your request: " + ex.Message,
                AuthorId = botMessage.AuthorId,
                AuthorName = botMessage.AuthorName,
                Timestamp = botMessage.Timestamp
            };
            Console.WriteLine(ex);
        }
        finally
        {
            IsLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public class ChatMessageModel : IChatMessage
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Text { get; set; } = "";
        public string AuthorId { get; set; } = "";
        public string AuthorName { get; set; } = "";
        public string? AuthorImageUrl { get; set; }
        public DateTime Timestamp { get; set; }
        public bool IsTyping { get; set; } = false;
    }
}