@page "/ai-search"
@using Telerik.Blazor.Components
@using Telerik.Blazor
@using blazor_progress_rag_demo.Services
@inject NucliaSearchService NucliaService

<div class="k-d-flex k-flex-col k-min-h-screen k-bg-surface k-pb-20">
    
    @if (!HasSearched)
    {
        @* Hero Section *@
        <HeroSection />
    }
    else
    {
        @* Results Header *@
        <div class="k-d-flex k-flex-col k-align-items-center k-pt-10 k-px-4">
             <h1 class="k-h1 k-font-weight-bold k-mb-4 k-text-center">
                Discover <span class="text-gradient-purple-blue">Progress Agentic RAG Knowledge</span>
            </h1>
        </div>
    }

    @* Search Section *@
    <div class="k-d-flex k-flex-col k-align-items-center @(HasSearched ? "k-mt-4" : "k-mt-10") k-w-full k-px-4">
        
        @* Search Bar *@
        <div class="search-box-container k-w-full">
            <TelerikTextBox @bind-Value="@SearchQuery" 
                            Placeholder="Ask about PARAG features, deployment, security, integrations..."
                            Size="@ThemeConstants.TextBox.Size.Large"
                            Rounded="@ThemeConstants.TextBox.Rounded.Full">
                <TextBoxPrefixTemplate>
                    <div class="k-pl-2 k-color-subtle">
                        <TelerikSvgIcon Icon="@SvgIcon.Plus" Size="@ThemeConstants.SvgIcon.Size.Large" />
                    </div>
                </TextBoxPrefixTemplate>
                <TextBoxSuffixTemplate>
                    <div class="k-d-flex k-align-items-center k-gap-2 k-pr-1">
                        <TelerikButton FillMode="@ThemeConstants.Button.FillMode.Flat" 
                                       Icon="@SvgIcon.MicrophoneOutline" 
                                       Title="Voice Search" 
                                       Class="k-rounded-full k-color-subtle" />
                        
                        <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                       FillMode="@ThemeConstants.Button.FillMode.Solid"
                                       Icon="@SvgIcon.ArrowUp"
                                       Class="k-rounded-full k-w-10 k-h-10 k-p-0 k-d-flex k-justify-content-center k-align-items-center"
                                       OnClick="@HandleSearch" />
                    </div>
                </TextBoxSuffixTemplate>
            </TelerikTextBox>
        </div>

        @if (!HasSearched)
        {
            @* Popular Searches *@
            <div class="k-mt-10 k-d-flex k-flex-col k-align-items-center k-w-full k-max-w-screen-lg">
                <div class="k-font-size-sm k-color-subtle k-mb-4">Popular searches:</div>
                
                <div class="k-d-flex k-justify-content-center k-w-full">
                     <TelerikChipList Data="@PopularSearchItems"
                                     TextField="Text"
                                     SelectionMode="@ChipListSelectionMode.Single"
                                     SelectedItemsChanged="@((IEnumerable<PopularSearchItem> items) => OnChipSelected(items))"
                                     Rounded="@ThemeConstants.Chip.Rounded.Full"
                                     Size="@ThemeConstants.Chip.Size.Medium"
                                     Class="k-justify-content-center" />
                </div>
            </div>
        }
        else
        {
            @* Search Results *@
            <div class="k-mt-10 k-w-full k-max-w-screen-lg">
                <div class="k-p-6">
                    @if (IsSearching && string.IsNullOrEmpty(SearchResult?.Response))
                    {
                        <div class="k-d-flex k-justify-content-center k-align-items-center k-p-4">
                            <TelerikLoader Size="@ThemeConstants.Loader.Size.Large" />
                        </div>
                    }
                    else if (SearchResult != null)
                    {
                        <div class="k-font-size-md k-line-height-md k-mb-4" style="white-space: pre-wrap;">
                            @SearchResult.Response
                        </div>
                    }
                </div>
            </div>

            @* Related Searches *@
            <div class="k-mt-10 k-d-flex k-flex-col k-align-items-center k-w-full k-max-w-screen-lg">
                <div class="k-font-size-sm k-color-subtle k-mb-4">Related searches:</div>
                
                <div class="k-d-flex k-justify-content-center k-w-full">
                     <TelerikChipList Data="@PopularSearchItems"
                                     TextField="Text"
                                     SelectionMode="@ChipListSelectionMode.Single"
                                     SelectedItemsChanged="@((IEnumerable<PopularSearchItem> items) => OnChipSelected(items))"
                                     Rounded="@ThemeConstants.Chip.Rounded.Full"
                                     Size="@ThemeConstants.Chip.Size.Medium"
                                     Class="k-justify-content-center" />
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string SearchQuery { get; set; } = string.Empty;
    private bool HasSearched { get; set; } = false;
    private bool IsSearching { get; set; } = false;
    private StreamingAskResult? SearchResult { get; set; }

    public class PopularSearchItem
    {
        public string Text { get; set; } = string.Empty;
    }

    private List<PopularSearchItem> PopularSearchItems { get; set; } = new List<PopularSearchItem>
    {
        new PopularSearchItem { Text = "What is PARAG and how does it work?" },
        new PopularSearchItem { Text = "Deployment options and requirements" },
        new PopularSearchItem { Text = "Security features and compliance" },
        new PopularSearchItem { Text = "API integration and capabilities" },
        new PopularSearchItem { Text = "Pricing and licensing options" },
        new PopularSearchItem { Text = "Use cases and customer success stories" }
    };

    private async Task HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery)) return;

        HasSearched = true;
        IsSearching = true;
        SearchResult = new StreamingAskResult();

        try
        {
            SearchResult = await NucliaService.AskAsync(SearchQuery, (text) =>
            {
                if (SearchResult != null)
                {
                    SearchResult.Response = text;
                    InvokeAsync(StateHasChanged);
                }
            });
        }
        finally
        {
            IsSearching = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnChipSelected(IEnumerable<PopularSearchItem> items)
    {
        var selected = items.FirstOrDefault();
        if (selected != null)
        {
            SearchQuery = selected.Text;
            await HandleSearch();
        }
    }
}
