@page "/ai-search"
@using Telerik.Blazor.Components
@using Telerik.Blazor
@using blazor_progress_rag_demo.Services
@inject NucliaSearchService NucliaService
@inject NavigationManager NavigationManager

<div class="ai-search-container k-pos-relative k-overflow-x-hidden k-overflow-y-auto">
    @if (!HasResults)
    {
        @* Decorative circle background - only show when no results *@
        <div class="ai-search-decorative-circle k-pos-absolute">
            <div class="ai-search-decorative-inner k-pos-absolute">
                <div class="ai-search-gradient-bg k-w-full k-h-full" />
            </div>
        </div>

        @* Decorative network visualization image on the right *@
        <VectorsBackground Show="true" />
    }

    @* Main content container *@
    <div class="ai-search-content k-d-flex k-flex-column k-pos-relative k-overflow-hidden">
        @if (!HasResults)
        {
            @* Initial state: Large header with description *@
            <div class="k-d-flex k-flex-column k-gap-8 rag-hero-wrapper">
                <h1 class="ai-search-title !k-mb-0 k-h1">
                    Discover
                    <br />
                    Progress Agentic RAG Knowledge
                </h1>
                <p class="ai-search-description !k-mb-0">
                    Search our comprehensive Nuclia knowledge base with AI-powered intelligent search for precise, contextual results about Nuclia features, capabilities, and best practices
                </p>
            </div>

            @* Search input section - centered horizontally *@
            <div class="ai-search-input-wrapper k-d-flex k-flex-column k-gap-8 search-input-wrapper k-w-full">
                <SearchInput Query="@Query"
                             QueryChanged="@((value) => Query = value)"
                             OnSearchClick="@HandleSearch"
                             IsLoading="@IsLoading"
                             Placeholder="Ask about PARAG features, deployment, security, integrations..." />

                @* Popular searches section *@
                <div class="k-d-flex k-flex-column k-w-full k-gap-3">
                    <p class="ai-search-popular-label !k-mb-0">
                        Popular searches:
                    </p>
                    <div class="k-d-flex k-flex-wrap k-gap-1.5 k-justify-content-flex-start k-pb-1.5">
                        @foreach (var searchText in PopularSearches)
                        {
                            <SearchPill Text="@searchText"
                                        OnClick="@(() => HandleExampleSearch(searchText))"
                                        Disabled="@IsLoading" />
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            @* Results state: Compact header with integrated search *@
            <div class="ai-search-results-hero k-d-flex k-flex-column k-gap-9 k-pos-relative hero">
                @* Decorative elements container with overflow clipping *@
                <div class="ai-search-results-decorative-container k-pos-absolute k-overflow-hidden">
                    @* Decorative gradient circle behind title *@
                    <div class="ai-search-results-gradient-circle k-pos-absolute">
                        <div class="ai-search-results-gradient-inner k-pos-absolute">
                            <div class="ai-search-gradient-bg k-w-full k-h-full" />
                        </div>
                    </div>

                    @* Vertical gradient shadow *@
                    <div class="ai-search-results-shadow k-pos-absolute" />
                </div>

                <h1 class="ai-search-results-title !k-mb-0 k-text-center k-pos-relative">
                    Discover Progress Agentic RAG Knowledge
                </h1>

                @* Search input - centered and integrated *@
                <div class="ai-search-results-input-wrapper k-w-full k-pos-relative">
                    <SearchInput Query="@Query"
                                 QueryChanged="@((value) => Query = value)"
                                 OnSearchClick="@HandleSearch"
                                 IsLoading="@IsLoading"
                                 Placeholder="What is PARAG and how does it work?" />
                </div>
            </div>
        }

        @* Results section *@
        @if (HasResults)
        {
            <div class="ai-search-results-section k-d-flex k-flex-column k-overflow-hidden k-w-full results-section">
                <div class="ai-search-results-content-wrapper k-d-flex k-flex-column k-gap-16 k-w-full results-content">
                    @* Answer content *@
                    @if (IsLoading)
                    {
                        <GradientLoader Title="Searching<br />Knowledge Base"
                                        Subtitle="Analyzing your query..." />
                    }

                    @if (!IsLoading && !string.IsNullOrEmpty(Answer))
                    {
                        <div class="ai-search-answer-text markdown-content">
                            <MarkdownContent Text="@Answer" />
                        </div>
                    }

                    @* Related searches section *@
                    @if (!IsLoading && !string.IsNullOrEmpty(Answer))
                    {
                        <div class="k-d-flex k-flex-column k-gap-3">
                            <p class="ai-search-popular-label !k-mb-0">
                                Related searches:
                            </p>
                            <div class="k-d-flex k-flex-wrap k-justify-content-flex-start k-gap-1">
                                @foreach (var searchText in PopularSearches)
                                {
                                    <SearchPill Text="@searchText"
                                                OnClick="@(() => HandleExampleSearch(searchText))"
                                                Disabled="@IsLoading" />
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string Query { get; set; } = string.Empty;
    private bool IsLoading { get; set; } = false;
    private string Answer { get; set; } = string.Empty;
    private string CurrentQuestion { get; set; } = string.Empty;

    private bool HasResults => !string.IsNullOrEmpty(Answer) || IsLoading || !string.IsNullOrEmpty(CurrentQuestion);

    private List<string> PopularSearches = new List<string>
    {
        "What is PARAG and how does it work?",
        "Deployment options and requirements",
        "Security features and compliance",
        "API integration and capabilities",
        "Pricing and licensing options",
        "Use cases and customer success stories"
    };

    protected override void OnInitialized()
    {
        // Check for query parameter from navigation
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("query", out var queryParam))
        {
            Query = queryParam.ToString();
            _ = HandleSearch();
        }
    }

    private async Task HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(Query) || IsLoading)
        {
            return;
        }

        IsLoading = true;
        Answer = string.Empty;
        CurrentQuestion = Query;
        StateHasChanged();

        try
        {
            await NucliaService.AskVerseAsync(Query, (partialResponse) =>
            {
                Answer = partialResponse;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Answer = $"Sorry, I encountered an error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleExampleSearch(string searchText)
    {
        Query = searchText;
        await HandleSearch();
    }
}
