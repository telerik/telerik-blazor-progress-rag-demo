@page "/financial-analysis"
@using Telerik.Blazor.Components
@using Telerik.SvgIcons
@using System.Collections.ObjectModel
@using System.Text.Json
@using System.Text.Json.Serialization
@inject blazor_progress_rag_demo.Services.NucliaSearchService NucliaService

<div class="k-d-flex k-h-screen k-w-full k-overflow-hidden">
    <!-- Drawer -->
    <TelerikDrawer @ref="Drawer"
                   Data="@DrawerItems"
                   MiniMode="false"
                   Mode="@DrawerMode.Push"
                   @bind-Expanded="@DrawerExpanded"
                   Width="280px"
                   Class="chat-drawer k-w-full k-h-full">
        <DrawerContent>
            <div class="k-d-flex k-flex-col k-h-full k-w-full k-bg-surface">
                <!-- Header -->
                <div class="k-d-flex k-align-items-center k-justify-content-between k-p-4 k-border-b k-border-solid k-border-subtle">
                    <div class="k-d-flex k-align-items-center k-gap-2">
                        <TelerikButton Icon="@SvgIcon.Menu" OnClick="@ToggleDrawer" FillMode="@ThemeConstants.Button.FillMode.Flat" />
                        <span class="k-font-weight-bold k-font-size-lg">Finance Analysis</span>
                    </div>
                    <div class="k-d-flex k-gap-2">
                        <TelerikButton Icon="@SvgIcon.Share" FillMode="@ThemeConstants.Button.FillMode.Flat">Share</TelerikButton>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="k-flex-1 k-overflow-hidden k-d-flex k-flex-col k-relative" id="chat-container">
                    <TelerikChat Data="@ChatMessages"
                                 OnSendMessage="@OnSendMessageHandler"
                                 AuthorId="@CurrentUserId"
                                 Class="k-h-full"
                                 Width="100%"
                                 Height="100%">
                        <MessageTemplate>
                            @{
                                var message = context.Message;
                                if (message != null)
                                {
                                    <div>
                                        @message.Text
                                    </div>

                                    @if (message.Charts != null && message.Charts.Any())
                                    {
                                        @foreach (var chart in message.Charts)
                                        {
                                            <div class="k-card k-p-4 k-mt-2" style="width: 100%; min-width: 400px;">
                                                <TelerikChart>
                                                    <ChartSeriesItems>
                                                        @foreach (var series in chart.Series)
                                                        {
                                                            <ChartSeries Type="ChartSeriesType.Column"
                                                                         Name="@series.Name"
                                                                         Data="@(series.Data.Cast<object>())">
                                                            </ChartSeries>
                                                        }
                                                    </ChartSeriesItems>
                                                    <ChartCategoryAxes>
                                                        <ChartCategoryAxis Categories="@chart.Categories.ToArray()" />
                                                    </ChartCategoryAxes>
                                                    <ChartTitle Text="@chart.Title" />
                                                    <ChartLegend Position="ChartLegendPosition.Bottom" />
                                                </TelerikChart>
                                                <div class="k-text-center k-mt-2">
                                                    <a href="#" class="k-link k-color-primary">Preview</a>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else if (message.HasChart)
                                    {
                                        <div class="k-card k-p-4 k-mt-2" style="width: 100%; min-width: 400px;">
                                            <TelerikChart>
                                                <ChartSeriesItems>
                                                    <ChartSeries Type="ChartSeriesType.Column"
                                                                 Name="Revenue"
                                                                 Data="@message.ChartData">
                                                    </ChartSeries>
                                                </ChartSeriesItems>
                                                <ChartCategoryAxes>
                                                    <ChartCategoryAxis Categories="@message.ChartCategories" />
                                                </ChartCategoryAxes>
                                                <ChartTitle Text="Revenue Comparison (in millions)" />
                                                <ChartLegend Position="ChartLegendPosition.Bottom" />
                                            </TelerikChart>
                                            <div class="k-text-center k-mt-2">
                                                <a href="#" class="k-link k-color-primary">Preview</a>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </MessageTemplate>
                    </TelerikChat>
                </div>
            </div>
        </DrawerContent>
        <Template>
            <div class="k-d-flex k-flex-col k-h-full k-justify-content-between k-p-4 k-bg-surface-alt">
                <div class="k-d-flex k-flex-col k-gap-2">
                    <TelerikButton Icon="@SvgIcon.Plus" Class="k-w-full k-mb-4 k-justify-content-start">New chat</TelerikButton>
                    
                    <div class="k-d-flex k-flex-col k-gap-1">
                        <TelerikButton Icon="@SvgIcon.Search" FillMode="@ThemeConstants.Button.FillMode.Flat" Class="k-justify-content-start k-text-left">Search chats</TelerikButton>
                        <TelerikButton Icon="@SvgIcon.Folder" FillMode="@ThemeConstants.Button.FillMode.Flat" Class="k-justify-content-start k-text-left">Library</TelerikButton>
                    </div>
                    
                    <div class="k-mt-6">
                        <span class="k-color-subtle k-font-size-xs k-font-weight-bold k-text-uppercase k-mb-2 k-d-block">Chats</span>
                        <div class="k-d-flex k-flex-col k-gap-1">
                            @foreach (var item in HistoryItems)
                            {
                                <div class="k-p-2 k-rounded k-cursor-pointer hover:k-bg-surface k-text-truncate k-font-size-sm" title="@item">
                                    @item
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="k-d-flex k-align-items-center k-gap-3 k-mt-auto k-pt-4 k-border-t k-border-solid k-border-subtle">
                    <TelerikAvatar Type="AvatarType.Icon" ThemeColor="@ThemeConstants.Avatar.ThemeColor.Primary">
                        <TelerikSvgIcon Icon="@SvgIcon.User" />
                    </TelerikAvatar>
                    <div class="k-d-flex k-flex-col">
                        <span class="k-font-weight-bold k-font-size-sm">John Smith</span>
                        <span class="k-font-size-xs k-color-subtle">Manager</span>
                    </div>
                </div>
            </div>
        </Template>
    </TelerikDrawer>
</div>

<style>
    .chat-drawer .k-drawer-wrapper {
        border-right: 1px solid var(--k-color-border-subtle);
    }
    /* Remove ListView borders */
    .k-listview {
        border: none !important;
        background: transparent !important;
    }
    .k-listview-content {
        border: none !important;
        background: transparent !important;
    }
    .k-listview-item {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
    }
</style>

@code {
    private TelerikDrawer<DrawerItem>? Drawer { get; set; }
    private bool DrawerExpanded { get; set; } = true;
    private string CurrentUserId { get; set; } = "user";

    private ObservableCollection<ChatMessageModel> ChatMessages { get; set; } = new ObservableCollection<ChatMessageModel>();

    private List<DrawerItem> DrawerItems { get; set; } = new List<DrawerItem>(); // Not used in Template mode but required for Data param

    private List<string> HistoryItems { get; set; } = new List<string>
    {
        "How do I get started with Kendo...",
        "What are the best KendoReact co...",
        "How to implement theming and s..."
    };

    protected override void OnInitialized()
    {
        // Initial Welcome Message
        ChatMessages.Add(new ChatMessageModel
        {
            Text = "How do I get started with KendoReact components?",
            AuthorId = "user",
            AuthorName = "John Smith",
            Timestamp = DateTime.Now.AddMinutes(-10)
        });
        
        // Bot Response (Simulated)
        ChatMessages.Add(new ChatMessageModel
        {
            Text = "I can help you with that. Please ask specifically about financial comparisons if you want to see charts.",
            AuthorId = "bot",
            AuthorName = "Assistant",
            Timestamp = DateTime.Now
        });
    }

    private async Task OnSendMessageHandler(ChatSendMessageEventArgs args)
    {
        var userMessage = new ChatMessageModel
        {
            Text = args.Message,
            AuthorId = CurrentUserId,
            AuthorName = "John Smith",
            Timestamp = DateTime.Now
        };

        ChatMessages.Add(userMessage);

        // Bot Response Placeholder
        var botMessage = new ChatMessageModel
        {
            Text = "Thinking...",
            AuthorId = "bot",
            AuthorName = "Assistant",
            Timestamp = DateTime.Now
        };
        ChatMessages.Add(botMessage);

        try 
        {
            var result = await NucliaService.AskChartsAsync(args.Message);

            // Parse the JSON response
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };
            
            var json = result.Response;
            // Clean up markdown code blocks if present
            if (json.Contains("```json"))
            {
                var start = json.IndexOf("```json") + 7;
                var end = json.LastIndexOf("```");
                if (end > start)
                {
                    json = json.Substring(start, end - start);
                }
            }
            else if (json.Contains("```"))
            {
                var start = json.IndexOf("```") + 3;
                var end = json.LastIndexOf("```");
                if (end > start)
                {
                    json = json.Substring(start, end - start);
                }
            }

            var answer = JsonSerializer.Deserialize<ChartAugmentedAnswer>(json, options);

            if (answer != null)
            {
                // Replace the placeholder message with the actual response
                var index = ChatMessages.IndexOf(botMessage);
                if (index != -1)
                {
                    ChatMessages[index] = new ChatMessageModel
                    {
                        Text = answer.Answer,
                        AuthorId = botMessage.AuthorId,
                        AuthorName = botMessage.AuthorName,
                        Timestamp = botMessage.Timestamp,
                        Charts = answer.Charts
                    };
                }
            }
        }
        catch (Exception ex)
        {
            var index = ChatMessages.IndexOf(botMessage);
            if (index != -1)
            {
                ChatMessages[index] = new ChatMessageModel
                {
                    Text = "Sorry, I encountered an error processing your request: " + ex.Message,
                    AuthorId = botMessage.AuthorId,
                    AuthorName = botMessage.AuthorName,
                    Timestamp = botMessage.Timestamp
                };
            }
            Console.WriteLine(ex);
        }
    }

    private void ToggleDrawer()
    {
        DrawerExpanded = !DrawerExpanded;
    }

    public class DrawerItem
    {
        public string Text { get; set; } = "";
        public ISvgIcon? Icon { get; set; }
    }

    public class ChatMessageModel
    {
        public string Text { get; set; } = "";
        public string AuthorId { get; set; } = "";
        public string AuthorName { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public bool HasChart { get; set; }
        public List<object>? ChartData { get; set; }
        public string[]? ChartCategories { get; set; }
        public List<ChartDataModel>? Charts { get; set; }
    }

    public class ChartAugmentedAnswer
    {
        [JsonPropertyName("answer")]
        public string Answer { get; set; } = "";
        
        [JsonPropertyName("charts")]
        public List<ChartDataModel> Charts { get; set; } = new();
    }

    public class ChartDataModel
    {
        [JsonPropertyName("title")]
        public string Title { get; set; } = "";
        
        [JsonPropertyName("categories")]
        public List<string> Categories { get; set; } = new();
        
        [JsonPropertyName("series")]
        public List<SeriesDataModel> Series { get; set; } = new();
    }

    public class SeriesDataModel
    {
        [JsonPropertyName("name")]
        public string Name { get; set; } = "";
        
        [JsonPropertyName("data")]
        public List<double> Data { get; set; } = new();
    }
}
